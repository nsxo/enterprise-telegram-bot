# 🚀 Deployment Guide - Enterprise Telegram Bot

## 📋 Overview

This guide provides comprehensive instructions for deploying the Enterprise Telegram Bot to various platforms, with Railway being the recommended option for production deployments.

## 🎯 Deployment Options

### **1. Railway (Recommended)**
- **Pros**: Easy setup, automatic deployments, PostgreSQL included
- **Cons**: Limited free tier, potential costs at scale
- **Best for**: Production deployments, small to medium scale

### **2. Heroku**
- **Pros**: Mature platform, good documentation
- **Cons**: No free tier, higher costs
- **Best for**: Production deployments with existing Heroku experience

### **3. Docker (Self-hosted)**
- **Pros**: Full control, cost-effective at scale
- **Cons**: Requires infrastructure management
- **Best for**: Large scale deployments, custom requirements

## 🚀 Railway Deployment

### **Prerequisites**
1. GitHub account with the bot repository
2. Railway account (free tier available)
3. Telegram Bot Token from @BotFather
4. Stripe account for payments

### **Step 1: Prepare Repository**
```bash
# Ensure all changes are committed
git add .
git commit -m "Prepare for Railway deployment"
git push origin main
```

### **Step 2: Connect to Railway**
1. Go to [Railway.app](https://railway.app)
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose your bot repository
5. Railway will automatically detect the Python project

### **Step 3: Configure Environment Variables**
In Railway dashboard, add these environment variables:

```bash
# Required Variables
BOT_TOKEN=your_telegram_bot_token_here
ADMIN_GROUP_ID=-1001234567890
ADMIN_USER_ID=123456789
DATABASE_URL=postgresql://... (auto-generated by Railway)
WEBHOOK_URL=https://your-app.railway.app

# Stripe Configuration
STRIPE_API_KEY=sk_live_your_stripe_api_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# Security
SECRET_KEY=your_super_secret_key_here
WEBHOOK_SECRET_TOKEN=your_webhook_secret_token_here

# Application Settings
PORT=8000
GUNICORN_WORKERS=2
GUNICORN_THREADS=2
GUNICORN_TIMEOUT=30
LOG_LEVEL=INFO
```

### **Step 4: Add PostgreSQL Database**
1. In Railway dashboard, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically set `DATABASE_URL`

### **Step 5: Deploy**
1. Railway will automatically deploy on push to main branch
2. Monitor deployment logs for any issues
3. Check the generated domain (e.g., `https://your-app.railway.app`)

### **Step 6: Configure Webhooks**
1. **Telegram Webhook**:
   ```bash
   curl -X POST "https://api.telegram.org/bot{BOT_TOKEN}/setWebhook" \
        -H "Content-Type: application/json" \
        -d '{
          "url": "https://your-app.railway.app/telegram-webhook",
          "secret_token": "your_webhook_secret_token_here"
        }'
   ```

2. **Stripe Webhook**:
   - Go to Stripe Dashboard → Webhooks
   - Add endpoint: `https://your-app.railway.app/stripe-webhook`
   - Select events: `checkout.session.completed`, `payment_intent.succeeded`
   - Copy webhook secret to `STRIPE_WEBHOOK_SECRET`

### **Step 7: Initialize Database**
```bash
# Run database setup (Railway will handle this automatically)
# Or manually via Railway CLI:
railway run python scripts/setup_db.py
```

## 🐳 Docker Deployment

### **Local Docker Testing**
```bash
# Build the image
docker build -f deployment/Dockerfile -t enterprise-telegram-bot .

# Run with environment file
docker run -p 8000:8000 --env-file .env enterprise-telegram-bot

# Or with individual environment variables
docker run -p 8000:8000 \
  -e BOT_TOKEN=your_token \
  -e DATABASE_URL=your_db_url \
  enterprise-telegram-bot
```

### **Production Docker Deployment**
```bash
# Build optimized production image
docker build -f deployment/Dockerfile \
  --target production \
  -t enterprise-telegram-bot:latest .

# Run with proper resource limits
docker run -d \
  --name telegram-bot \
  --restart unless-stopped \
  -p 8000:8000 \
  --env-file .env \
  --memory=512m \
  --cpus=1.0 \
  enterprise-telegram-bot:latest
```

### **Docker Compose**
```yaml
# docker-compose.yml
version: '3.8'

services:
  bot:
    build:
      context: .
      dockerfile: deployment/Dockerfile
      target: production
    ports:
      - "8000:8000"
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - DATABASE_URL=${DATABASE_URL}
      - STRIPE_API_KEY=${STRIPE_API_KEY}
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=telegram_bot
      - POSTGRES_USER=bot_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
```

## 🔧 Manual Deployment

### **Server Requirements**
- **OS**: Ubuntu 20.04+ or CentOS 8+
- **Python**: 3.11+
- **PostgreSQL**: 13+
- **Memory**: 512MB+ RAM
- **Storage**: 1GB+ free space

### **Installation Steps**
```bash
# 1. Update system
sudo apt update && sudo apt upgrade -y

# 2. Install Python and dependencies
sudo apt install python3.11 python3.11-venv python3-pip postgresql postgresql-contrib nginx

# 3. Clone repository
git clone https://github.com/yourusername/enterprise-telegram-bot.git
cd enterprise-telegram-bot

# 4. Create virtual environment
python3.11 -m venv venv
source venv/bin/activate

# 5. Install dependencies
pip install -r requirements.txt

# 6. Set up environment
cp env.template .env
nano .env  # Edit with your configuration

# 7. Set up database
python scripts/setup_db.py

# 8. Test the application
python src/webhook_server.py
```

### **Production Setup with Gunicorn**
```bash
# Install Gunicorn
pip install gunicorn

# Create systemd service
sudo nano /etc/systemd/system/telegram-bot.service
```

```ini
[Unit]
Description=Enterprise Telegram Bot
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/path/to/enterprise-telegram-bot
Environment=PATH=/path/to/enterprise-telegram-bot/venv/bin
ExecStart=/path/to/enterprise-telegram-bot/venv/bin/gunicorn \
    --bind 0.0.0.0:8000 \
    --workers 2 \
    --threads 2 \
    --timeout 30 \
    src.webhook_server:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# Enable and start service
sudo systemctl daemon-reload
sudo systemctl enable telegram-bot
sudo systemctl start telegram-bot
sudo systemctl status telegram-bot
```

### **Nginx Configuration**
```nginx
# /etc/nginx/sites-available/telegram-bot
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```bash
# Enable site
sudo ln -s /etc/nginx/sites-available/telegram-bot /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 🔐 Security Configuration

### **Environment Variables**
```bash
# Generate secure secrets
openssl rand -hex 32  # For SECRET_KEY
openssl rand -hex 32  # For WEBHOOK_SECRET_TOKEN

# Set proper file permissions
chmod 600 .env
chown botuser:botuser .env
```

### **Firewall Configuration**
```bash
# Allow only necessary ports
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### **SSL Certificate (Let's Encrypt)**
```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d your-domain.com

# Auto-renewal
sudo crontab -e
# Add: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 📊 Monitoring & Maintenance

### **Health Checks**
```bash
# Check application health
curl https://your-domain.com/health

# Check system resources
htop
df -h
free -h
```

### **Log Monitoring**
```bash
# View application logs
sudo journalctl -u telegram-bot -f

# View nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### **Database Maintenance**
```bash
# Backup database
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql

# Monitor database size
psql $DATABASE_URL -c "SELECT pg_size_pretty(pg_database_size(current_database()));"
```

### **Updates and Maintenance**
```bash
# Update application
git pull origin main
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart telegram-bot

# Update system packages
sudo apt update && sudo apt upgrade -y
```

## 🚨 Troubleshooting

### **Common Issues**

#### **1. Webhook Not Receiving Updates**
```bash
# Check webhook status
curl "https://api.telegram.org/bot{BOT_TOKEN}/getWebhookInfo"

# Verify webhook URL
curl -X POST "https://api.telegram.org/bot{BOT_TOKEN}/setWebhook" \
     -H "Content-Type: application/json" \
     -d '{"url": "https://your-domain.com/telegram-webhook"}'
```

#### **2. Database Connection Issues**
```bash
# Test database connection
python -c "
import os
import psycopg2
conn = psycopg2.connect(os.environ['DATABASE_URL'])
print('Database connected successfully')
conn.close()
"
```

#### **3. Stripe Webhook Failures**
```bash
# Check Stripe webhook logs
# Go to Stripe Dashboard → Webhooks → Select endpoint → View logs
```

#### **4. High Memory Usage**
```bash
# Monitor memory usage
ps aux | grep gunicorn
free -h

# Adjust Gunicorn workers if needed
# Reduce workers in systemd service file
```

### **Performance Optimization**
```bash
# Database optimization
psql $DATABASE_URL -c "VACUUM ANALYZE;"

# Application optimization
# Adjust Gunicorn workers based on CPU cores
# Monitor and adjust connection pool size
```

## 📈 Scaling Considerations

### **Horizontal Scaling**
- Use load balancer (nginx, haproxy)
- Multiple application instances
- Shared database (consider read replicas)

### **Vertical Scaling**
- Increase server resources
- Optimize database queries
- Implement caching (Redis)

### **Monitoring at Scale**
- Application performance monitoring (APM)
- Database performance monitoring
- Infrastructure monitoring (CPU, memory, disk)

---

**For additional support, refer to the project documentation or create an issue on GitHub.** 